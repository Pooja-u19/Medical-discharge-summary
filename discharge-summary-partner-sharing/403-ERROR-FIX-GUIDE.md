# 403 Forbidden Error Fix Guide

## Root Cause Analysis

The 403 Forbidden error is caused by three main issues:

1. **API Key Mismatch**: The API key in your `.env` file doesn't match the one generated by AWS API Gateway
2. **CORS Configuration**: API Gateway was configured to only allow requests from CloudFront domain, blocking localhost
3. **Missing Headers**: Some required headers were not being sent properly

## Fixes Applied

### 1. Frontend Changes

#### Enhanced API Configuration (`axiosConfig.tsx`)
- Added comprehensive request/response logging
- Ensured proper headers are sent with every request
- Added debug information for troubleshooting

#### Environment Configuration (`environment.ts`)
- Added debug logging to verify environment variables are loaded correctly
- Removed hardcoded fallback API key

#### API Debugger Utility (`apiDebugger.ts`)
- Created comprehensive debugging tool to test API calls
- Added CORS preflight testing functionality

#### AddRequest Component (`AddRequest.tsx`)
- Integrated debugging functionality
- Added detailed logging for API calls

### 2. Backend Changes

#### Lambda Functions
- **create-request.mjs**: Added proper CORS headers to all responses
- **get-request.mjs**: Added proper CORS headers to all responses
- Both handlers now support OPTIONS preflight requests

#### CloudFormation Template (`template.yaml`)
- Updated CORS configuration to allow all origins (`*`) for development
- This change needs to be deployed to AWS

### 3. API Key Retrieval

#### Get API Key Script (`get-api-key.js`)
- Created script to retrieve the correct API key from AWS
- Can be run to get the actual API key value

## Steps to Fix the Issue

### Step 1: Get the Correct API Key

Run the API key retrieval script:
```bash
cd d:\Discharge-Summary-Project\discharge-summary-partner-sharing
node get-api-key.js
```

Or manually get it from AWS Console:
1. Go to API Gateway console
2. Click on "API Keys" in the left sidebar
3. Find "DischargeSummaryApiKey"
4. Click "Show" to reveal the key value

### Step 2: Update Environment Variables

Update your `.env` file with the correct API key:
```
REACT_APP_API_KEY=YOUR_ACTUAL_API_KEY_HERE
```

### Step 3: Deploy Backend Changes

Deploy the updated CloudFormation template and Lambda functions:
```bash
sam build
sam deploy
```

### Step 4: Test the Fix

1. Start your React development server:
```bash
cd client
npm start
```

2. Open browser developer tools (F12)
3. Go to Console tab
4. Try uploading a document
5. Check the debug logs for API configuration and CORS testing

### Step 5: Verify Headers

The debug output should show:
- API key is present and not "NOT_SET"
- Request headers include `x-api-key`, `Content-Type`, and `Accept`
- CORS preflight request returns 200 status
- Main API request returns 200 instead of 403

## Testing Commands

### Frontend Testing
```javascript
// In browser console, test API configuration
import { debugApiCall, testCorsPreflightRequest } from './src/utils/apiDebugger';
debugApiCall();
testCorsPreflightRequest();
```

### Backend Testing
```bash
# Test API endpoint directly
curl -X POST https://4hn7we6o38.execute-api.us-east-1.amazonaws.com/dev/api/v1/document/upload \
  -H "Content-Type: application/json" \
  -H "x-api-key: YOUR_API_KEY" \
  -d '{"files":[{"contentType":"application/pdf","size":1024,"documentType":"other_documents","fileName":"test.pdf"}]}'
```

## Expected Results After Fix

1. **No more 403 errors** when uploading documents
2. **Proper CORS headers** in all responses
3. **Debug logs** showing successful API configuration
4. **Successful file uploads** with presigned URLs returned

## Security Note

For production deployment:
1. Revert CORS `AllowOrigin` from `*` to your specific domain
2. Use environment-specific API keys
3. Enable proper authentication/authorization

## Troubleshooting

If you still get 403 errors after applying fixes:

1. **Check API Key**: Verify the API key is correct and active
2. **Check Deployment**: Ensure backend changes are deployed
3. **Check Browser Cache**: Clear browser cache and hard refresh
4. **Check Network Tab**: Look at actual request headers being sent
5. **Check CloudWatch Logs**: Review Lambda function logs for errors

## Files Modified

### Frontend
- `client/src/api/axiosConfig.tsx`
- `client/src/config/environment.ts`
- `client/src/components/pages/Admin/RequestsManagement/AddRequest/AddRequest.tsx`
- `client/.env`
- `client/src/utils/apiDebugger.ts` (new)

### Backend
- `src/handlers/create-request.mjs`
- `src/handlers/get-request.mjs`
- `template.yaml`
- `get-api-key.js` (new)

The fixes address all three root causes of the 403 error and provide comprehensive debugging tools to verify the solution works correctly.